<script>

(async () => {

    // Load wasm binary
    const bin = await (await fetch('test.wasm')).arrayBuffer();
    const valid = WebAssembly.validate(bin);
    console.log('valid', valid);

    let mod;

    // WASM Environment
    const env = {
        js: {
            log: console.log,
        },
    };

    mod = await WebAssembly.instantiate(bin, env);
    const {
        push_ref, pop_ref, alloc, mark, mmark, do_gc, free, coalesce, m
    } = mod.instance.exports;
    window.m = m;
    window.mod = mod.instance.exports;

    class Node {
        constructor(addr) {
            this.addr = addr;
            this.arr = new Int32Array(m.buffer, addr, 3 * 4);
            console.log(this.toString(), this);
        }
        get enum() { return this.arr[0]; }
        get next() { return this.arr[1]; }
        get value() { return this.arr[2]; }
        set enum(v) { this.arr[0] = v; }
        set next(v) { this.arr[1] = v; }
        set value(v) { this.arr[2] = v; }
        toString() { return `Node { ${this.enum} ${this.enum ? '' : this.next} ${this.enum ? '' : this.value} }`; }
    }
    window.Node = Node;

    const node_bf = mod.instance.exports.static_ref_bf_010();

    function constructNode(addr, prevAddr = 0, value = 0) {
        const ret = new Node(addr);
        if (prevAddr) {
            ret.enum = 0;
            ret.next = prevAddr;
            ret.value = value;
        } else {
            ret.enum = 1;
        }
        return ret;
    }

    // Make a list linked list of 300 i32 nodes in reverse numerical order
    let i = 0;
    push_ref(constructNode(alloc(3, node_bf)).addr);

    for (let i = 0; i < 300; i++) {
        push_ref(
            constructNode(
                alloc(3, node_bf),
                pop_ref(),
                i,
            ).addr);
        const n = new Node(pop_ref())
        console.log(n.toString(), n);
        push_ref(n.addr);
    }

    console.log('made 300 nodes');
    // do_gc();

    // Iterate over LL

    // Dup list head
    const h = pop_ref();
    push_ref(h);

    const l = [];
    let n = new Node(h);

    for (let i = 0; i < 1000 && n.enum != 1 && n.next; i++) {
        console.log(n.toString(), n);
        l.push(n.value);
        n = new Node(n.next);
    }
    console.log(l);

    // Reverse LL


    // Verify LL gets GC'd
})();
</script>